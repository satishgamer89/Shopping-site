<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>The Aachar Port</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{--main:#7b1e1e;--accent:#d35400;--bg:#fff7f2}
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:var(--bg)}
header{background:var(--main);color:#fff;padding:12px 18px;display:flex;justify-content:space-between;align-items:center}
header a{color:#fff;margin-left:14px;text-decoration:none;font-weight:bold;cursor:pointer}
section{padding:20px}
.hidden{display:none}
.products{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px}
.card{background:#fff;padding:12px;border-radius:8px;box-shadow:0 3px 8px #0002}
.card img{width:100%;height:160px;object-fit:cover;border-radius:6px}
.admin-actions button{margin-top:6px}
button{background:var(--accent);color:#fff;border:none;padding:8px;border-radius:6px;cursor:pointer}
</style>
</head>

<body>

<header>
 <b>The Aachar Port</b>
 <div>
  <a onclick="show('home')">Home</a>
  <a onclick="show('cart')">Cart</a>
  <a id="adminLink" class="hidden" onclick="show('admin')">Admin</a>
  <a id="logoutBtn" class="hidden" onclick="logout()">Logout</a>
 </div>
</header>

<section id="home">
 <h2>Products</h2>
 <div class="products" id="products"></div>
</section>

<section id="cart" class="hidden">
 <h2>Cart</h2>
 <div id="cartItems"></div>
 <h3>Total ₹<span id="total">0</span></h3>
</section>

<section id="admin" class="hidden">
 <h2>Admin Panel</h2>
 <input id="pName" placeholder="Name">
 <input id="pPrice" type="number" placeholder="Price">
 <input id="pDesc" placeholder="Description">
 <input id="pIng" placeholder="Ingredients">
 <input id="pImages" type="file" multiple>
 <button onclick="addProduct()">Add Product</button>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, updateDoc }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig={
 apiKey:"AIzaSyA871BbtKAIFdOEIbzCZG7GWAtStNSy8IA",
 authDomain:"the-aachar-port.firebaseapp.com",
 projectId:"the-aachar-port"
};

const CLOUDINARY="dmnsblldh";
const UPLOAD_PRESET="aachar_upload";
const ADMIN="satishbhattrai54@gmail.com";

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

let user=null,productsData=[],cart=[];

window.show=id=>{
 document.querySelectorAll("section").forEach(s=>s.classList.add("hidden"));
 document.getElementById(id).classList.remove("hidden");
};

onAuthStateChanged(auth,u=>{
 user=u;
 adminLink.classList.toggle("hidden",!(u&&u.email===ADMIN));
 logoutBtn.classList.toggle("hidden",!u);
 loadProducts();
});

window.logout=()=>signOut(auth);

async function loadProducts(){
 products.innerHTML="";
 const snap=await getDocs(collection(db,"products"));
 productsData=[];
 snap.forEach(d=>{
  const p={id:d.id,...d.data()};
  p.images = Array.isArray(p.images)&&p.images.length?p.images:["https://via.placeholder.com/300"];
  productsData.push(p);

  products.innerHTML+=`
   <div class="card">
    <img src="${p.images[0]}">
    <h3>${p.name}</h3>
    <p>₹${p.price}</p>
    <button onclick="addToCart('${p.id}')">Add to Cart</button>
    ${user&&user.email===ADMIN?`
    <div class="admin-actions">
     <button onclick="editProduct('${p.id}')">Edit</button>
     <button onclick="deleteProduct('${p.id}')">Delete</button>
    </div>`:""}
   </div>`;
 });
}

window.addToCart=id=>{
 const p=productsData.find(x=>x.id===id);
 if(!p)return alert("Product not found");
 const item=cart.find(x=>x.id===id);
 item?item.qty++:cart.push({id,name:p.name,price:p.price,qty:1});
 renderCart();
};

function renderCart(){
 cartItems.innerHTML="";
 let t=0;
 cart.forEach(c=>{
  t+=c.price*c.qty;
  cartItems.innerHTML+=`${c.name} x ${c.qty} = ₹${c.price*c.qty}<br>`;
 });
 total.innerText=t;
}

window.deleteProduct=async id=>{
 if(!confirm("Delete product?"))return;
 await deleteDoc(doc(db,"products",id));
 loadProducts();
};

window.editProduct=id=>{
 const p=productsData.find(x=>x.id===id);
 pName.value=p.name;
 pPrice.value=p.price;
 pDesc.value=p.desc;
 pIng.value=p.ing;
 window.editing=id;
 show("admin");
};

window.addProduct=async()=>{
 let imgs=[];
 for(const f of pImages.files){
  const fd=new FormData();
  fd.append("file",f);
  fd.append("upload_preset",UPLOAD_PRESET);
  const r=await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY}/image/upload`,{method:"POST",body:fd});
  const d=await r.json();
  imgs.push(d.secure_url);
 }

 if(window.editing){
  await updateDoc(doc(db,"products",window.editing),{
   name:pName.value,price:+pPrice.value,desc:pDesc.value,ing:pIng.value,images:imgs
  });
  window.editing=null;
 }else{
  await addDoc(collection(db,"products"),{
   name:pName.value,price:+pPrice.value,desc:pDesc.value,ing:pIng.value,images:imgs
  });
 }

 pName.value=pPrice.value=pDesc.value=pIng.value="";
 pImages.value="";
 show("home");
 loadProducts();
};
</script>

</body>
</html>
